# Руководство по конфигурации Химера 2.0

## Лимиты демо-доступа
- `DAILY_MESSAGE_LIMIT` - количество сообщений в день для неавторизованных пользователей (по умолчанию: 10)

## Промпты и генерация

### Параметры генерации
- `GENERATION_PARAMS` - словарь параметров для DeepSeek:
  - `temperature` - креативность ответов (0.0-2.0)
  - `top_p` - nucleus sampling параметр (0.0-1.0)
  - `max_tokens` - максимальная длина ответа
  - `frequency_penalty` - штраф за повторения
  - `presence_penalty` - штраф за упоминание тем
  
### Режимно-зависимые параметры генерации

- `MODE_GENERATION_PARAMS` - словарь параметров для каждого режима общения:
  - `base` - базовые параметры (используют GENERATION_PARAMS)
  - `talk` - параметры для режима беседы:
    - temperature: 0.92 (высокая для эмоциональности)
    - top_p: 0.92 (высокий для разнообразия)
    - max_tokens: 1000 (меньше для динамичности диалога)
    - frequency_penalty: 0.35 (низкий для естественности)
    - presence_penalty: 0.5 (средний)
  - `expert` - параметры для экспертного режима:
    - temperature: 0.55 (низкая для точности и фактологичности)
    - top_p: 0.8 (консервативный выбор слов)
    - max_tokens: 1500 (больше для развернутых объяснений)
    - frequency_penalty: 0.65 (высокий для избежания повторов)
    - presence_penalty: 0.72 (высокий для разнообразия тем)
  - `creative` - параметры для творческого режима:
    - temperature: 0.75 (средняя с уклоном в креативность)
    - top_p: 0.97 (очень высокий для неожиданных выборов)
    - max_tokens: 2200 (максимум для богатых текстов)
    - frequency_penalty: 0.25 (низкий для поэтических повторов)
    - presence_penalty: 0.78 (высокий для оригинальности)

Параметры автоматически применяются при определении режима в UserSessionActor.

- `GENERATION_PARAMS_LOG_CONFIG` - настройки логирования параметров:
  - `log_parameters_usage` - логировать использованные параметры в Event Store (по умолчанию: True)
  - `log_response_length` - включать длину ответа в логи (по умолчанию: True)
  - `debug_mode_selection` - подробное логирование выбора режима (по умолчанию: False)

### Управление промптами
- `PROMPT_CONFIG` - настройки системного промпта:
  - `system_prompt_interval` - включать промпт каждое N сообщение
  - `enable_periodic_prompt` - включить периодичность
  - `prompt_strategy` - стратегия: "always", "periodic", "adaptive"
  - `use_json_mode` - использовать JSON формат ответов
  - `json_fallback_enabled` - автоматический fallback при ошибке JSON
  - `log_prompt_usage` - логировать использование промптов в консоль (по умолчанию: True)
  - `log_prompt_preview_length` - количество символов промпта для показа в логах (по умолчанию: 100)
  
### JSON-заглушка для периодических промптов
- `JSON_STUB_PROMPT` - минимальный промпт-заглушка при отключенном основном промпте (по умолчанию: "Ты — Химера, гениальная девушка. Ответь только в формате json: {\"response\": \"твой ответ\"}")
  - Используется когда `enable_periodic_prompt = True` и промпт не включается
  - Обеспечивает наличие слова "json" для DeepSeek API
  - Минимальное влияние на поведение Химеры

### Логирование параметров генерации
- `GENERATION_PARAMS_LOG_CONFIG` - настройки логирования параметров генерации:
  - `log_parameters_usage` - сохранять ли использованные параметры в Event Store (по умолчанию: True)
  - `log_response_length` - включать ли длину ответа в события (по умолчанию: True)
  - `debug_mode_selection` - выводить ли подробную отладку при выборе режима (по умолчанию: False)

При включенном `log_parameters_usage` система создает события `GenerationParametersUsedEvent` для каждой генерации, содержащие:
- Использованный режим (talk/expert/creative/base)
- Все параметры генерации (temperature, top_p, max_tokens и др.)
- Длину сгенерированного ответа (если включен `log_response_length`)
- ID пользователя и временную метку

Это позволяет анализировать эффективность разных параметров и оптимизировать генерацию.

### Валидация структурированных ответов
- `JSON_VALIDATION_CONFIG` - настройки валидации JSON-ответов:
  - `strict_mode` - требовать все опциональные поля (по умолчанию: False)
  - `log_validation_errors` - логировать ошибки валидации (по умолчанию: True)
  - `validation_timeout_ms` - таймаут валидации в миллисекундах (по умолчанию: 10)
  - `max_validation_errors` - максимум ошибок в одном логе (по умолчанию: 5)

- `JSON_SCHEMA_INSTRUCTIONS` - инструкции для структурированных ответов по режимам:
  - `talk` - схема с emotional_tone и engagement_level
  - `expert` - схема с confidence, sources и assumptions
  - `creative` - схема с style_markers и metaphors
  
### Настройка режимных промптов

- `MODE_PROMPT_CONFIG` - управление построением промптов для режимов:
  - `use_mode_modifiers` - использовать ли модификаторы режимов (по умолчанию: True)
  - `combine_with_base` - комбинировать базовый промпт с модификатором (по умолчанию: True)
  - `modifier_separator` - разделитель между базой и модификатором (по умолчанию: "\n\n")

### Примечания по режимным промптам
1. **Архитектура промптов** - базовый промпт всегда используется, модификаторы добавляются к нему
2. **TODO-маркеры** - текущие модификаторы содержат TODO для будущей реализации
3. **Fallback** - если модификатор содержит TODO или отсутствует, используется только базовый промпт

## Определение режимов общения

### Настройки истории и уверенности
- `MODE_HISTORY_SIZE` - максимальный размер истории режимов для отслеживания паттернов общения (по умолчанию: 5)
- `MODE_CONFIDENCE_THRESHOLD` - минимальная уверенность для режима по умолчанию при отсутствии явных паттернов (по умолчанию: 0.3)
- `MODE_SCORE_NORMALIZATION_FACTOR` - делитель для нормализации уверенности в определении режима (по умолчанию: 1.5)

### Контекстные паттерны
- `CONTEXTUAL_PATTERN_PHRASE_WEIGHT` - вес для точных фраз при определении режима (по умолчанию: 2.5)
- `CONTEXTUAL_PATTERN_DOMAIN_WEIGHT` - вес для доменных маркеров (по умолчанию: 0.5)
- `CONTEXTUAL_PATTERN_CONTEXT_MULTIPLIER` - множитель для контекстных слов с усилителями (по умолчанию: 1.5)
- `CONTEXTUAL_PATTERN_SUPPRESSOR_MULTIPLIER` - множитель для контекстных слов с подавителями (по умолчанию: 0.3)

### Производительность определения режимов
- `MODE_DETECTION_CACHE_ENABLED` - включить кэширование результатов определения паттернов (по умолчанию: True)
- `MODE_DETECTION_MAX_TIME_MS` - максимальное время определения режима в миллисекундах (по умолчанию: 5)
- `MODE_DETECTION_DEBUG_LOGGING` - включить подробное логирование процесса определения режима (по умолчанию: True)

### Примечания по контекстным паттернам
1. **Трехуровневая система** обрабатывает паттерны с разными приоритетами:
   - Точные фразы (вес 2.5) - максимальный приоритет
   - Контекстные слова с модификаторами - средний приоритет
   - Доменные маркеры (вес 0.5) - минимальный приоритет

2. **Усилители и подавители** позволяют учитывать контекст многозначных слов. Например, "объясни устройство" → expert, но "объясни, почему мне плохо" → talk.

3. **События PatternDebugEvent** сохраняются при включенном MODE_DETECTION_DEBUG_LOGGING для анализа работы системы.

### Примечания по режимам
1. **История режимов** используется для усиления уверенности при стабильном паттерне общения. Если последние 3 сообщения были в одном режиме, уверенность умножается на `stable_history_multiplier` из `prompts.py`.

2. **Нормализация уверенности** преобразует сырые очки паттернов в значение от 0 до 1. Меньший делитель = выше уверенность.

3. **Пороговое значение** используется как fallback уверенность когда текст слишком короткий или не содержит паттернов.

## Actor System

### Основные настройки
- `ACTOR_SYSTEM_NAME` - имя системы акторов для логирования (по умолчанию: "chimera")
- `ACTOR_MESSAGE_QUEUE_SIZE` - максимальный размер очереди сообщений для каждого актора (по умолчанию: 1000)
- `ACTOR_SHUTDOWN_TIMEOUT` - время ожидания graceful shutdown в секундах (по умолчанию: 5.0)
- `ACTOR_MESSAGE_TIMEOUT` - таймаут ожидания нового сообщения в message loop (по умолчанию: 1.0)

### Retry механизм
- `ACTOR_MESSAGE_RETRY_ENABLED` - включить механизм повторной отправки сообщений при переполнении очереди (по умолчанию: True)
- `ACTOR_MESSAGE_MAX_RETRIES` - максимальное количество попыток отправки сообщения (по умолчанию: 3)
- `ACTOR_MESSAGE_RETRY_DELAY` - начальная задержка между попытками в секундах (по умолчанию: 0.1)
- `ACTOR_MESSAGE_RETRY_MAX_DELAY` - максимальная задержка между попытками в секундах (по умолчанию: 2.0)

### Dead Letter Queue
- `DLQ_MAX_SIZE` - максимальный размер Dead Letter Queue перед автоочисткой (по умолчанию: 1000)
- `DLQ_CLEANUP_INTERVAL` - интервал автоматической очистки DLQ в секундах (по умолчанию: 3600)
- `DLQ_METRICS_ENABLED` - включить сбор метрик по Dead Letter Queue (по умолчанию: True)

## Логирование

### Основные настройки
- `LOG_LEVEL` - уровень логирования (DEBUG, INFO, WARNING, ERROR) (по умолчанию: "INFO")
- `LOG_FORMAT` - формат сообщений логов (по умолчанию: "%(asctime)s - %(name)s - %(levelname)s - %(message)s")
- `LOG_DATE_FORMAT` - формат даты в логах (по умолчанию: "%Y-%m-%d %H:%M:%S")

### JSON логирование
- `ENABLE_JSON_LOGGING` - включить JSON логирование параллельно с текстовым (по умолчанию: True)
- `JSON_LOG_FILE` - путь к файлу JSON логов (по умолчанию: "logs/chimera.json")

### Ротация логов
- `LOG_ROTATION_ENABLED` - включить автоматическую ротацию файлов логов (по умолчанию: True)
- `LOG_MAX_BYTES` - максимальный размер файла логов в байтах перед ротацией (по умолчанию: 1048576 = 1 МБ)
- `LOG_BACKUP_COUNT` - количество архивных файлов логов для хранения (по умолчанию: 5)

## Мониторинг

### Метрики производительности
- `ENABLE_PERFORMANCE_METRICS` - включить сбор метрик производительности (по умолчанию: True)
- `METRICS_LOG_INTERVAL` - интервал логирования метрик в секундах (по умолчанию: 60)
- `SLOW_OPERATION_THRESHOLD` - порог в секундах для определения медленных операций (по умолчанию: 0.1)

## Event Store

### Основные настройки
- `EVENT_STORE_TYPE` - тип хранилища событий: "memory" для in-memory, будет "postgres" в фазе 3 (по умолчанию: "memory")
- `EVENT_STORE_MAX_MEMORY_EVENTS` - максимальное количество событий в памяти перед автоочисткой (по умолчанию: 10000)
- `EVENT_STORE_STREAM_CACHE_SIZE` - размер LRU кэша для часто используемых потоков событий (по умолчанию: 100)
- `EVENT_STORE_CLEANUP_INTERVAL` - интервал автоматической очистки старых событий в секундах (по умолчанию: 3600)
- `EVENT_STORE_CLEANUP_BATCH_SIZE` - количество событий удаляемых за одну операцию очистки (по умолчанию: 100)

### Сериализация событий
- `EVENT_SERIALIZATION_FORMAT` - формат сериализации событий (по умолчанию: "json")
- `EVENT_TIMESTAMP_FORMAT` - формат timestamp для сериализации событий (по умолчанию: "%Y-%m-%dT%H:%M:%S.%fZ")

## Event Archival (Архивация событий)

### Основные настройки архивации
- `ARCHIVE_ENABLED` - включить автоматическую архивацию старых событий (по умолчанию: True)
- `ARCHIVE_DAYS_THRESHOLD` - архивировать события старше указанного количества дней (по умолчанию: 90)
- `ARCHIVE_BATCH_SIZE` - количество событий для архивации за одну транзакцию (по умолчанию: 1000)
- `ARCHIVE_COMPRESSION_LEVEL` - уровень сжатия gzip от 1 до 9, где 6 - баланс скорости и сжатия (по умолчанию: 6)

### Расписание архивации
- `ARCHIVE_SCHEDULE_HOUR` - час запуска архивации в UTC (по умолчанию: 4)
- `ARCHIVE_SCHEDULE_MINUTE` - минута запуска архивации (по умолчанию: 0)
- `ARCHIVE_QUERY_TIMEOUT` - таймаут для запросов архивации в секундах (по умолчанию: 30.0)
- `ARCHIVE_DRY_RUN` - режим тестирования: только логирование без реального удаления (по умолчанию: False)

## Storage Monitoring (Мониторинг хранилища)

### Основные настройки мониторинга
- `STORAGE_MONITORING_ENABLED` - включить мониторинг размеров таблиц БД (по умолчанию: True)
- `STORAGE_CHECK_INTERVAL` - интервал проверки размеров в секундах (по умолчанию: 3600 - каждый час)
- `STORAGE_METRICS_LOG_INTERVAL` - интервал логирования метрик в секундах (по умолчанию: 86400 - раз в сутки)

### Пороги алертов
- `STORAGE_ALERT_THRESHOLD_MB` - порог предупреждения о размере таблицы в МБ (по умолчанию: 1000)
- `STORAGE_CRITICAL_THRESHOLD_MB` - критический порог размера таблицы в МБ (по умолчанию: 5000)
- `STORAGE_GROWTH_WINDOW_DAYS` - окно анализа роста БД в днях для прогнозирования (по умолчанию: 7)
- `STORAGE_GROWTH_ALERT_THRESHOLD` - порог алерта при прогнозе роста, 1.5 = рост на 50% (по умолчанию: 1.5)

## SystemActor (Системный актор)

### Настройки системного актора
- `SYSTEM_ACTOR_ENABLED` - включить SystemActor для maintenance задач (по умолчанию: True)
- `SYSTEM_METRICS_CACHE_TTL` - время жизни кэша метрик в секундах (по умолчанию: 300 - 5 минут)
- `SYSTEM_ALERT_COOLDOWN` - минимальный интервал между одинаковыми алертами в секундах (по умолчанию: 3600 - 1 час)

## Настройки Event Replay Service (аналитика событий)
- `EVENT_REPLAY_MAX_EVENTS` - максимальное количество событий, возвращаемых за один запрос (по умолчанию: 10000)
- `EVENT_REPLAY_BATCH_SIZE` - размер батча при чтении больших объемов данных из БД (по умолчанию: 5000)
- `EVENT_REPLAY_DEFAULT_PERIOD_DAYS` - период анализа по умолчанию для метода get_trigger_distribution в днях (по умолчанию: 7)
- `EVENT_REPLAY_CACHE_TTL` - время жизни кэша для метрик в секундах, зарезервировано для будущего использования (по умолчанию: 300 - 5 минут)

## ПАРАМЕТРЫ EVENT REPLAY SERVICE

### Event Replay Service settings:
- `EVENT_REPLAY_MAX_EVENTS` - максимальное количество событий, возвращаемых за один запрос (по умолчанию: 10000)
- `EVENT_REPLAY_BATCH_SIZE` - размер батча при чтении больших объемов данных из БД (по умолчанию: 5000)
- `EVENT_REPLAY_DEFAULT_PERIOD_DAYS` - период анализа по умолчанию для метода get_trigger_distribution в днях (по умолчанию: 7)
- `EVENT_REPLAY_CACHE_TTL` - время жизни кэша для метрик в секундах, зарезервировано для будущего использования (по умолчанию: 300 - 5 минут)
- `ANALYSIS_CACHE_TTL_DAYS` - время жизни кэша результатов анализа в днях (по умолчанию: 30)
- `ANALYSIS_CACHE_TABLE` - название таблицы для кэширования результатов эмоционального анализа (по умолчанию: "emotional_analysis_cache")
- `ANALYSIS_MAX_EVENTS_PER_USER` - максимальное количество эмоциональных событий для анализа одного пользователя (по умолчанию: 10000)
- `ANALYSIS_BATCH_SIZE` - размер батча при обработке больших объемов эмоциональных данных (по умолчанию: 500)
- `CLUSTERING_MIN_K` - минимальное количество кластеров для K-means анализа (по умолчанию: 3)
- `CLUSTERING_MAX_K` - максимальное количество кластеров для K-means анализа (по умолчанию: 10)
- `CLUSTERING_SILHOUETTE_THRESHOLD` - минимальный порог силуэтного коэффициента для валидации качества кластеризации (по умолчанию: 0.5)
- `PATTERN_MIN_FREQUENCY` - минимальная частота повторения для определения устойчивого эмоционального паттерна (по умолчанию: 3)
- `PATTERN_MIN_CONFIDENCE` - минимальный уровень уверенности для детекции паттернов от 0.0 до 1.0 (по умолчанию: 0.7)
- `TEMPORAL_WINDOW_MINUTES` - временное окно в минутах для группировки связанных эмоциональных событий (по умолчанию: 30)
- `ANOMALY_CONTAMINATION` - ожидаемая доля аномалий в данных от 0.0 до 1.0 (по умолчанию: 0.05 - 5%)
- `ANOMALY_Z_SCORE_THRESHOLD` - порог Z-score для детекции эмоциональных аномалий (по умолчанию: 3.0)
- `CYCLE_MIN_PERIOD_DAYS` - минимальный период эмоционального цикла в днях (по умолчанию: 3)
- `CYCLE_MAX_PERIOD_DAYS` - максимальный период эмоционального цикла в днях (по умолчанию: 30)
- `CYCLE_MIN_AMPLITUDE` - минимальная амплитуда эмоциональных колебаний для детекции цикла от 0.0 до 1.0 (по умолчанию: 0.2)


## PostgreSQL Event Store

### Подключение к базе данных
- `POSTGRES_DSN` - строка подключения к PostgreSQL (по умолчанию: "postgresql://chimera:password@localhost:5432/chimera_db")
- `POSTGRES_POOL_MIN_SIZE` - минимальный размер пула подключений (по умолчанию: 10)
- `POSTGRES_POOL_MAX_SIZE` - максимальный размер пула подключений (по умолчанию: 20)
- `POSTGRES_COMMAND_TIMEOUT` - таймаут выполнения команд в секундах (по умолчанию: 60)
- `POSTGRES_CONNECT_TIMEOUT` - таймаут подключения к БД в секундах (по умолчанию: 10)
- `POSTGRES_RETRY_ATTEMPTS` - количество попыток подключения при сбое (по умолчанию: 3)
- `POSTGRES_RETRY_DELAY` - задержка между попытками подключения в секундах (по умолчанию: 1.0)

### Батчевая запись событий
- `EVENT_STORE_BATCH_SIZE` - количество событий для батчевой записи (по умолчанию: 100)
- `EVENT_STORE_FLUSH_INTERVAL` - интервал автоматической записи буфера в секундах (по умолчанию: 1.0)
- `EVENT_STORE_MAX_BUFFER_SIZE` - максимальный размер буфера до принудительной записи (по умолчанию: 1000)

### Миграция данных
- `EVENT_STORE_MIGRATION_BATCH` - размер батча при миграции событий (по умолчанию: 1000)
- `EVENT_STORE_MIGRATION_DELAY` - задержка между батчами для снижения нагрузки в секундах (по умолчанию: 0.1)
- `EVENT_STORE_MIGRATION_VERIFY` - выполнять ли верификацию после миграции (по умолчанию: True)
### Advisory lock настройки
- `USE_DOUBLE_KEY_ADVISORY_LOCK` - использовать два int4 ключа вместо одного для advisory locks, что значительно снижает вероятность коллизий хэшей (по умолчанию: True)

### Переключение реализации
- `EVENT_STORE_TYPE` - тип используемого Event Store: "memory" или "postgres" (по умолчанию: "memory")

### Примечания по настройке

1. **Размер пула подключений** зависит от количества акторов:
   - Для 3-5 акторов: min=10, max=20
   - Для 10+ акторов: min=20, max=50
   - Учитывайте лимиты PostgreSQL на количество подключений

2. **Батчевая запись** критична для производительности:
   - Маленький батч (10-50) = низкая латентность, больше нагрузка на БД
   - Большой батч (200-500) = высокая латентность, эффективная запись
   - Оптимально: 100-200 событий

3. **Буфер записи** защищает от потери событий:
   - При сбое БД события накапливаются в буфере
   - При превышении MAX_BUFFER_SIZE происходит принудительная запись
   - Размер буфера = BATCH_SIZE * 10 (запас на 10 батчей)

4. **Миграция** выполняется без остановки системы:
   - Сначала переключите EVENT_STORE_TYPE на "postgres"
   - Перезапустите приложение (начнет писать в PostgreSQL)
   - Запустите миграцию старых данных: `python -m database.event_store_migrator`

### Требования к PostgreSQL

- PostgreSQL 12+ (для оптимальной работы с JSONB)
- Расширение uuid-ossp: `CREATE EXTENSION IF NOT EXISTS "uuid-ossp";`
- Минимум 2GB RAM для эффективной работы
- SSD диск рекомендуется для Event Store

### Оценка размера БД

- 1 событие ≈ 1KB (с индексами)
- 1 миллион событий ≈ 1GB
- Индексы добавляют ~30% к размеру данных
- Планируйте x3 от ожидаемого размера для роста

## Примечания

1. **Retry механизм** использует exponential backoff - каждая следующая попытка происходит через удвоенное время, но не более `ACTOR_MESSAGE_RETRY_MAX_DELAY`.

2. **Dead Letter Queue** сохраняет сообщения, которые не удалось доставить после всех попыток. Автоочистка удаляет старые сообщения при превышении `DLQ_MAX_SIZE`.

3. **Метрики производительности** логируются только для операций, превышающих `SLOW_OPERATION_THRESHOLD` секунд.

4. **Ротация логов** автоматически архивирует файл логов при достижении `LOG_MAX_BYTES`. Архивные файлы именуются как `chimera.json.1`, `chimera.json.2` и т.д. Когда количество архивов превышает `LOG_BACKUP_COUNT`, самый старый файл удаляется.

## Redis

### Подключение
- `REDIS_URL` - URL подключения к Redis (по умолчанию: "redis://localhost:6379/0")
- `REDIS_POOL_MIN_SIZE` - минимальный размер пула подключений (по умолчанию: 5)
- `REDIS_POOL_MAX_SIZE` - максимальный размер пула подключений (по умолчанию: 10)
- `REDIS_CONNECT_TIMEOUT` - таймаут подключения в секундах (по умолчанию: 5)
- `REDIS_RETRY_ATTEMPTS` - количество попыток подключения при сбое (по умолчанию: 3)
- `REDIS_RETRY_DELAY` - задержка между попытками подключения в секундах (по умолчанию: 1.0)

### Настройки ключей
- `REDIS_KEY_PREFIX` - префикс для всех ключей Redis (по умолчанию: "chimera")
  - Помогает избежать коллизий при использовании общего Redis
  - Все ключи будут иметь формат: `chimera:key_name`
- `REDIS_DAILY_LIMIT_TTL` - время жизни счетчиков лимитов в секундах (по умолчанию: 86400 = 24 часа)
  - Автоматически удаляет устаревшие счетчики
  - Синхронизировано с ежедневным сбросом лимитов

### Рекомендации по настройке
1. **Размер пула подключений** зависит от нагрузки:
   - Для малых нагрузок: min=5, max=10
   - Для средних нагрузок: min=10, max=20
   - Для высоких нагрузок: min=20, max=50

2. **Таймауты** важны для стабильности:
   - Увеличьте CONNECT_TIMEOUT при нестабильной сети
   - Увеличьте RETRY_DELAY при высокой нагрузке на Redis

## DeepSeek API

### Основные настройки
- `DEEPSEEK_API_KEY` - API ключ для доступа к DeepSeek (обязательный)
- `DEEPSEEK_BASE_URL` - базовый URL API (по умолчанию: "https://api.deepseek.com/v1")
- `DEEPSEEK_MODEL` - модель для использования (по умолчанию: "deepseek-chat")
- `DEEPSEEK_TIMEOUT` - таймаут запросов в секундах (по умолчанию: 30)
- `DEEPSEEK_MAX_RETRIES` - максимальное количество попыток при ошибках (по умолчанию: 3)

## Валидация JSON-ответов

### Основные настройки
- `JSON_VALIDATION_ENABLED` - включить валидацию структурированных JSON-ответов (по умолчанию: True)
- `JSON_VALIDATION_LOG_FAILURES` - логировать неудачные валидации в Event Store (по умолчанию: True)  
- `JSON_VALIDATION_EVENT_BATCH_SIZE` - размер батча для событий валидации (по умолчанию: 10)

## Pydantic модели для структурированных ответов

С версии 2.1.1 система использует Pydantic модели для валидации JSON-ответов:

- `BaseResponse` - базовая модель с обязательным полем `response`
- `TalkResponse` - модель для режима беседы с `emotional_tone` и `engagement_level`
- `ExpertResponse` - модель для экспертного режима с `confidence`, `sources`, `assumptions`
- `CreativeResponse` - модель для творческого режима с `style_markers` и `metaphors`

### Параметры Pydantic валидации
- `PYDANTIC_RESPONSE_MIN_LENGTH` - минимальная длина поля response (по умолчанию: 1)
- `PYDANTIC_CONFIDENCE_MIN` - минимальное значение для confidence/engagement_level (по умолчанию: 0.0)
- `PYDANTIC_CONFIDENCE_MAX` - максимальное значение для confidence/engagement_level (по умолчанию: 1.0)
- `PYDANTIC_STRING_LIST_COERCE` - автоматически преобразовывать элементы списков в строки (по умолчанию: True)
- `PYDANTIC_VALIDATION_STRICT` - строгий режим валидации без приведения типов (по умолчанию: False)

Модели обеспечивают:
- Автоматическую валидацию типов
- Преобразование данных (например, числа в строки для списков)
- Понятные сообщения об ошибках
- Совместимость с будущей ORM интеграцией

### Примечания
1. **Валидация не влияет на работу бота** - это подготовительный механизм для будущих расширений
2. **События валидации** сохраняются в Event Store для анализа качества генерации
3. **Схемы валидации** определены в `models/response_schemas.py` для 4 режимов: base, talk, expert, creative

## Telegram Bot

### Основные настройки
- `TELEGRAM_BOT_TOKEN` - токен бота от BotFather (обязательный)
- `TELEGRAM_POLLING_TIMEOUT` - таймаут long polling в секундах (по умолчанию: 30)
- `TELEGRAM_TYPING_UPDATE_INTERVAL` - интервал обновления typing индикатора (по умолчанию: 5)
- `TELEGRAM_MAX_MESSAGE_LENGTH` - максимальная длина сообщения Telegram (по умолчанию: 4096)
- `TELEGRAM_TYPING_CLEANUP_THRESHOLD` - количество typing операций до автоматической очистки завершенных задач (по умолчанию: 100)
- `TELEGRAM_API_DEFAULT_TIMEOUT` - таймаут по умолчанию для вызовов Telegram API в секундах (по умолчанию: 10)
- `TELEGRAM_MAX_TYPING_TASKS` - максимальное количество одновременных typing индикаторов для защиты от переполнения памяти (по умолчанию: 1000)

### Команды авторизации
- `AUTH_PASSWORD_WAIT_TIMEOUT` - таймаут ожидания пароля после команды /auth в секундах (по умолчанию: 60)
  - После этого времени состояние ожидания автоматически сбрасывается
  - Рекомендация: 30-120 секунд

## Метрики и адаптация

- `CACHE_HIT_LOG_INTERVAL` - частота логирования cache hit rate
- `MIN_CACHE_HIT_RATE` - минимальный приемлемый cache hit rate для адаптивной стратегии

## Pydantic интеграция

### Основные модели системы

- **ActorMessage** - сообщения между акторами
  - Автоматическая генерация message_id
  - Валидация типов полей
  - Сохранена обратная совместимость через __getitem__

- **BaseEvent** - события в Event Store
  - Иммутабельность через frozen=True
  - Валидация version >= 0
  - Методы to_dict/from_dict для сериализации

- **UserSession** - данные сессии пользователя
  - Валидация mode из списка допустимых
  - Валидация mode_confidence в диапазоне 0-1
  - Автоматическое ограничение размера mode_history и cache_metrics
  - Подготовка к будущей ORM интеграции

### Параметры валидации основных структур

- `PYDANTIC_MESSAGE_TYPE_MIN_LENGTH` - минимальная длина message_type (по умолчанию: 0)
- `PYDANTIC_EVENT_TYPE_MIN_LENGTH` - минимальная длина event_type (по умолчанию: 1)
- `PYDANTIC_STREAM_ID_MIN_LENGTH` - минимальная длина stream_id (по умолчанию: 0)
- `PYDANTIC_MODE_HISTORY_MAX_SIZE` - максимальный размер истории режимов (по умолчанию: 10)
- `PYDANTIC_CACHE_METRICS_MAX_SIZE` - максимальный размер метрик кэша (по умолчанию: 100)

### Преимущества Pydantic

1. **Автоматическая валидация** при создании объектов
2. **Строгая типизация** с проверкой во время выполнения
3. **Сериализация/десериализация** через model_dump/model_validate
4. **Готовность к PostgreSQL** - легкая миграция на SQLModel
5. **Лучшие сообщения об ошибках** при невалидных данных

## Short-Term Memory (STM)

### Основные настройки буфера
- `STM_CONTEXT_SIZE_FOR_GENERATION` - количество исторических сообщений для контекста генерации (по умолчанию: 20)
- `STM_BUFFER_SIZE` - количество сообщений для хранения на пользователя (по умолчанию: 50)
  - Меньше значение = меньше памяти, но короче контекст
  - Больше значение = больше контекста, но выше нагрузка на БД
  - Рекомендация: 30-50 для обычных диалогов, 100+ для технических обсуждений

- `STM_CLEANUP_BATCH_SIZE` - количество записей для удаления за одну операцию (по умолчанию: 10)
  - Влияет на производительность операций очистки
  - Меньше = частые небольшие удаления
  - Больше = редкие массивные удаления
  
- `STM_QUERY_TIMEOUT` - таймаут запросов к БД в секундах (по умолчанию: 5.0)
  - Защита от зависших запросов
  - Увеличить при высокой нагрузке на БД

- `STM_MESSAGE_MAX_LENGTH` - максимальная длина одного сообщения перед обрезкой (по умолчанию: 4000)
  - Защита от переполнения БД длинными сообщениями
  - При обрезке в metadata добавляется флаг truncated и original_length
  - Рекомендация: 2000-4000 символов

### Формат контекста
- `STM_CONTEXT_FORMAT` - формат вывода контекста (по умолчанию: "structured")
  - "structured" - формат для DeepSeek API с полями role/content
  - "text" - отладочный формат с type/content/timestamp
  
- `STM_INCLUDE_METADATA` - включать ли метаданные в контекст (по умолчанию: True)
  - True = режимы, эмоции, уверенность будут доступны
  - False = только текст сообщений

- `STM_DEEPSEEK_ROLE_MAPPING` - маппинг ролей для DeepSeek API (по умолчанию: {"user": "user", "bot": "assistant"})
  - Преобразует внутренние типы сообщений в роли для API
  - "user" → "user", "bot" → "assistant"

### Метрики STM
- `STM_METRICS_ENABLED` - включить сбор метрик (по умолчанию: True)
- `STM_METRICS_LOG_INTERVAL` - интервал логирования метрик в секундах (по умолчанию: 300)
  - Слишком частое логирование может засорить логи
  - Рекомендация: 300-600 секунд для production
  
- `STM_METRICS_ENABLED` - включить сбор метрик (по умолчанию: True)
- `STM_METRICS_LOG_INTERVAL` - интервал логирования метрик в секундах (по умолчанию: 300)
  - Слишком частое логирование может засорить логи
  - Рекомендация: 300-600 секунд для production

- `STM_CONTEXT_REQUEST_TIMEOUT` - таймаут ожидания контекста из памяти в секундах (по умолчанию: 30)
  - Если MemoryActor не ответит за это время, генерация продолжится без исторического контекста
  - Защищает от зависания при проблемах с БД или перегрузке
  - Рекомендация: 10-30 секунд в зависимости от нагрузки

### Рекомендации по настройке

**Для небольших нагрузок (< 100 пользователей):**
- STM_BUFFER_SIZE = 50
- STM_CLEANUP_BATCH_SIZE = 10
- STM_QUERY_TIMEOUT = 5.0

**Для средних нагрузок (100-1000 пользователей):**
- STM_BUFFER_SIZE = 30-40
- STM_CLEANUP_BATCH_SIZE = 20
- STM_QUERY_TIMEOUT = 3.0

**Для высоких нагрузок (> 1000 пользователей):**
- STM_BUFFER_SIZE = 20-30
- STM_CLEANUP_BATCH_SIZE = 50
- STM_QUERY_TIMEOUT = 2.0
- Рассмотрите использование отдельного read-replica для чтения

  
## Настройки PerceptionActor

Параметры для актора анализа эмоций.

### Основные параметры
- `PERCEPTION_EMOTION_TIMEOUT` - таймаут для анализа одного текста в секундах (по умолчанию: 5.0)
  - Защищает от зависания при анализе сложных текстов
  - При превышении возвращается нейтральный эмоциональный вектор

- `PERCEPTION_THREAD_POOL_SIZE` - размер пула потоков для асинхронного анализа (по умолчанию: 3)
  - Определяет количество параллельных анализов
  - Увеличьте для высоких нагрузок

- `PERCEPTION_LOG_ERRORS` - логировать ли ошибки анализа эмоций (по умолчанию: True)
  - Полезно для отладки
  - В production можно отключить для уменьшения логов


## Настройки TalkModelActor

Параметры для актора режимов общения.

- `PARTNER_MODEL_REQUEST_TIMEOUT` - максимальное время ожидания ответа от TalkModelActor (по умолчанию: 0.3 секунды)
  - Предотвращает задержку генерации при недоступности Partner Persona
  - Уменьшите для более быстрого отклика, увеличьте если БД медленная

- `PARTNER_PERSONA_CACHE_TTL` - время жизни Partner Persona в Redis кэше (по умолчанию: 3600 секунд = 1 час)
  - Снижает нагрузку на БД при повторных обращениях пользователя
  - Увеличьте для стабильных пользователей, уменьшите для более динамичной адаптации

- `PARTNER_MODE_CONFIDENCE_THRESHOLD` - минимальная уверенность для использования Partner Persona (по умолчанию: 0.55)
  - При уверенности ниже порога используется анализ текущего сообщения
  - Уменьшите для большего доверия истории, увеличьте для приоритета текущему контексту
  
## PERSONALITY ANALYSIS - Настройки анализа личности

Параметры для периодического анализа стиля общения и черт личности.

- `PERSONALITY_ANALYSIS_BATCH_SIZE` - частота запуска анализа в сообщениях (по умолчанию: 10)
  - Анализ запускается каждые N сообщений пользователя
  - Уменьшите для более частой адаптации, увеличьте для снижения нагрузки на систему

- `PERSONALITY_ANALYSIS_HISTORY_LIMIT` - количество сообщений для анализа (по умолчанию: 50)
  - Определяет глубину истории для построения модели собеседника
  - Увеличьте для более точного анализа долгосрочных паттернов, уменьшите для фокуса на текущем контексте

- `PERSONALITY_ANALYSIS_ENABLED` - включение/отключение функционала (по умолчанию: True)
  - Позволяет полностью отключить анализ личности без изменения кода
  - Установите False при отладке или для снижения нагрузки в production

- `PARTNER_PERSONA_CHANGE_THRESHOLD` - порог изменения стиля для создания новой версии (по умолчанию: 0.2)
  - Новая версия Partner Persona создается при изменении любого компонента стиля более чем на это значение
  - Уменьшите для более чувствительной адаптации, увеличьте для стабильности модели


### Рекомендации по настройке

**Для разработки:**
- PERCEPTION_EMOTION_TIMEOUT = 5.0
- PERCEPTION_THREAD_POOL_SIZE = 3
- PERCEPTION_LOG_ERRORS = True

**Для production:**
- PERCEPTION_EMOTION_TIMEOUT = 2.0 (быстрее отказ при проблемах)
- PERCEPTION_THREAD_POOL_SIZE = 5-10 (в зависимости от нагрузки)
- PERCEPTION_LOG_ERRORS = False

## Circuit Breaker
- `CIRCUIT_BREAKER_ENABLED` - включить механизм Circuit Breaker (по умолчанию: True)
- `CIRCUIT_BREAKER_FAILURE_THRESHOLD` - количество ошибок для открытия (по умолчанию: 5)
- `CIRCUIT_BREAKER_RECOVERY_TIMEOUT` - время восстановления в секундах (по умолчанию: 60)

## PERSONALITY ACTOR - Настройки модуля личности

Параметры для управления базовой моделью личности Химеры и её динамическими изменениями.

- `PERSONALITY_MIN_TRAIT_VALUE` - минимальное значение черты личности (по умолчанию: 0.0)
  - Нижняя граница для всех черт личности
  - Обычно не требует изменения, используется для валидации

- `PERSONALITY_MAX_TRAIT_VALUE` - максимальное значение черты личности (по умолчанию: 1.0)
  - Верхняя граница для всех черт личности
  - Обычно не требует изменения, используется для нормализации

- `PERSONALITY_CORE_TRAIT_MINIMUM` - минимальный порог для ключевых черт (по умолчанию: 0.4)
  - Защищает базовую личность от чрезмерных изменений (40% от базового значения)
  - Уменьшите для большей пластичности личности, увеличьте для сохранения узнаваемости

- `PERSONALITY_SESSION_CHANGE_LIMIT` - максимальное изменение за сессию (по умолчанию: 0.2)
  - Ограничивает скорость изменения личности (20% от начального значения)
  - Уменьшите для более стабильной личности, увеличьте для быстрой адаптации

- `PERSONALITY_HISTORY_BUFFER_SIZE` - размер буфера истории изменений (по умолчанию: 100)
  - Количество сохраняемых состояний личности для анализа эволюции
  - Увеличьте для более глубокого анализа паттернов, уменьшите для экономии памяти

- `PERSONALITY_PROFILE_CACHE_TTL` - время жизни кэша профиля личности (по умолчанию: 86400 сек / 24 часа)
  - Определяет, как долго хранится вычисленный профиль в Redis
  - Уменьшите для более частого пересчета, увеличьте для снижения нагрузки

- `PERSONALITY_MODIFIER_CACHE_TTL` - время жизни кэша модификаторов (по умолчанию: 3600 сек / 1 час)
  - Определяет, как долго хранятся контекстные модификаторы личности
  - Уменьшите для более динамичных изменений, увеличьте для стабильности

- `PERSONALITY_QUERY_TIMEOUT` - таймаут запросов к БД (по умолчанию: 5.0 сек)
  - Максимальное время ожидания ответа от PostgreSQL
  - Увеличьте при медленной БД, уменьшите для быстрого отказа при проблемах
  
- `PERSONALITY_MIN_TRAIT_VALUE` - минимальное значение черты личности (по умолчанию: 0.0)
  - Определяет нижнюю границу диапазона для всех черт личности после вычислений
  - Увеличьте для гарантии минимальной активности всех черт (например, 0.1)

- `PERSONALITY_MAX_TRAIT_VALUE` - максимальное значение черты личности (по умолчанию: 1.0)
  - Определяет верхнюю границу диапазона для всех черт личности после вычислений
  - Уменьшите для более сбалансированного профиля без экстремальных значений

- `PERSONALITY_PROFILE_CACHE_TTL_SECONDS` - время жизни кэша профиля личности (по умолчанию: 300 сек / 5 минут)
  - Определяет, как долго хранится вычисленный профиль в Redis
  - Уменьшите для более частого пересчета при активных изменениях, увеличьте для снижения нагрузки
  
- `PERSONALITY_RECOVERY_DAYS` - количество дней неактивности для начала восстановления (по умолчанию: 7)
  - После этого периода личность начинает возвращаться к базовым значениям
  - Уменьшите для быстрого "забывания" контекста, увеличьте для долгой памяти о взаимодействиях
  
- `PERSONALITY_RECOVERY_RATE` - скорость восстановления к базовому профилю (по умолчанию: 0.1 / 10% в день)
  - Определяет, насколько быстро личность возвращается к исходному состоянию
  - Увеличьте для быстрого восстановления (0.2 = 20% в день), уменьшите для медленного (0.05 = 5% в день)

- `PERSONALITY_SESSION_CLEANUP_HOURS` - время хранения начального профиля сессии (по умолчанию: 24 часа)
  - Используется для ограничения изменений в рамках одной сессии (20% лимит)
  - Увеличьте для более длинных сессий, уменьшите для частого сброса ограничений

- `PERSONALITY_DOMINANCE_CHANGE_THRESHOLD` - минимальное изменение для события смены доминирующих черт (по умолчанию: 0.05)
  - Черта должна измениться минимум на 5% чтобы считаться значимым изменением
  - Уменьшите для более чувствительного отслеживания (0.01), увеличьте для игнорирования мелких флуктуаций (0.1)

- `PERSONALITY_BASELINE_CONVERGENCE_THRESHOLD` - порог схождения к базе для события стабилизации (по умолчанию: 0.95)
  - Когда профиль восстановился на 95% к базовым значениям, генерируется PersonalityStabilizedEvent
  - Увеличьте для более строгого определения стабилизации (0.98), уменьшите для раннего срабатывания (0.9)

- `PERSONALITY_EVENT_BATCH_SIZE` - размер батча для аналитических событий (по умолчанию: 10)
  - Зарезервировано для будущей батчевой обработки событий анализа личности
  - Увеличьте для меньшей частоты аналитики, уменьшите для более частых но мелких батчей
